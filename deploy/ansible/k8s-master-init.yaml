---
# Ansible Playbook: Initialize Kubernetes Master Node
# Target: Ubuntu 22.04 (Jammy)

- name: Initialize Kubernetes Master Node
  hosts: master
  become: yes
  vars:
    # Kubernetes 版本
    k8s_version: "1.30"
    # Pod 网络 CIDR (Flannel 默认使用)
    pod_network_cidr: "10.244.0.0/16"
    # API Server 监听地址 (master 节点的 private IP)
    apiserver_address: "192.168.56.10"
    # 国内镜像加速
    use_china_mirrors: true
    # 清华源地址
    tsinghua_mirror: "https://mirrors.tuna.tsinghua.edu.cn"

  tasks:
    # ============================================
    # 1. 系统准备
    # ============================================
    - name: Disable swap
      command: swapoff -a
      changed_when: false

    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: '.*swap.*'
        state: absent

    - name: Mask swap.target to prevent swap activation
      systemd:
        name: swap.target
        masked: yes

    - name: Load required kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Persist kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: Set sysctl parameters for Kubernetes
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/k8s.conf
        reload: yes
      loop:
        - { key: "net.bridge.bridge-nf-call-iptables", value: "1" }
        - { key: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
        - { key: "net.ipv4.ip_forward", value: "1" }

    # ============================================
    # 2. 安装 containerd
    # ============================================
    - name: Install dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Docker GPG key (for containerd)
      apt_key:
        url: "{{ tsinghua_mirror }}/docker-ce/linux/ubuntu/gpg"
        state: present
      when: use_china_mirrors

    - name: Add Docker repository (Tsinghua mirror)
      apt_repository:
        repo: "deb [arch=amd64] {{ tsinghua_mirror }}/docker-ce/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker-ce
      when: use_china_mirrors

    - name: Install containerd
      apt:
        name: containerd.io
        state: present
        update_cache: yes

    - name: Remove old containerd config
      file:
        path: /etc/containerd/config.toml
        state: absent

    - name: Generate default containerd config
      shell: containerd config default > /etc/containerd/config.toml

    - name: Configure containerd to use systemd cgroup
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'

    - name: Enable and start containerd
      systemd:
        name: containerd
        enabled: yes
        state: restarted
        daemon_reload: yes

    # ============================================
    # 3. 安装 kubeadm, kubelet, kubectl
    # ============================================
    - name: Add Kubernetes GPG key (Aliyun mirror)
      apt_key:
        url: "https://mirrors.aliyun.com/kubernetes-new/core/stable/v{{ k8s_version }}/deb/Release.key"
        state: present
      when: use_china_mirrors

    - name: Add Kubernetes repository (Aliyun mirror)
      apt_repository:
        repo: "deb https://mirrors.aliyun.com/kubernetes-new/core/stable/v{{ k8s_version }}/deb/ /"
        state: present
        filename: kubernetes
      when: use_china_mirrors

    - name: Install Kubernetes components
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes

    - name: Hold Kubernetes packages at current version
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl

    - name: Enable kubelet service
      systemd:
        name: kubelet
        enabled: yes

    # ============================================
    # 4. 初始化 Kubernetes Master
    # ============================================
    - name: Check if Kubernetes is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: k8s_init

    - name: Initialize Kubernetes master
      command: >
        kubeadm init
        --pod-network-cidr={{ pod_network_cidr }}
        --apiserver-advertise-address={{ apiserver_address }}
      register: kubeadm_init
      when: not k8s_init.stat.exists

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0755'

    - name: Copy admin.conf to root's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        mode: '0600'
      when: k8s_init.stat.exists or kubeadm_init is changed

    # ============================================
    # 5. 安装 Flannel 网络插件
    # ============================================
    - name: Download Flannel manifest
      get_url:
        url: https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
        dest: /tmp/kube-flannel.yml
        mode: '0644'

    - name: Apply Flannel network plugin
      command: kubectl apply -f /tmp/kube-flannel.yml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: flannel_apply
      changed_when: "'created' in flannel_apply.stdout or 'configured' in flannel_apply.stdout"