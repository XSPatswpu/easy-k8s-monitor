# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"

  # 虚拟机配置
  vms = [
    { name: "vm1", ip: "192.168.56.101", memory: 10240, cpus: 4 },
    { name: "vm2", ip: "192.168.56.102", memory: 10240, cpus: 4 },
    { name: "vm3", ip: "192.168.56.103", memory: 10240, cpus: 4 }
  ]

  vms.each do |vm_config|
    config.vm.define vm_config[:name] do |node|
      node.vm.hostname = vm_config[:name]

      # 配置 Private Network
      node.vm.network "private_network", ip: vm_config[:ip]

      node.vm.provider "virtualbox" do |vb|
        vb.name = "ubuntu-#{vm_config[:name]}"
        vb.memory = vm_config[:memory]
        vb.cpus = vm_config[:cpus]
      end

      # 基础配置（不配置代理，因为宿主机 TUN 会处理）
      node.vm.provision "shell", inline: <<-SHELL
        # 设置非交互模式
        export DEBIAN_FRONTEND=noninteractive

        # 配置默认网关为宿主机（通过宿主机的 TUN 访问外网）
        # 注意：这里不需要特殊配置，虚拟机会通过 NAT 访问宿主机

        # 更新系统
        apt-get update
        apt-get upgrade -y -q

        # 安装常用工具
        apt-get install -y -q \
          vim \
          curl \
          wget \
          net-tools \
          iputils-ping \
          dnsutils \
          traceroute \
          htop \
          tcpdump

        echo "=== #{vm_config[:name]} 配置完成 ==="
        echo "虚拟机 IP: #{vm_config[:ip]}"
        echo "宿主机 IP: 192.168.56.1"
        echo "流量将通过宿主机的 TUN 自动路由"
      SHELL
    end
  end
end